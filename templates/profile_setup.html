{% extends "layout.html" %}

{% block title %}Profil - Maman & B√©b√©{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- V√©rification du profil complet -->
    {% if not user_data or not user_data.prenom or not user_data.phone %}
    <div class="alert alert-warning">
        <div class="d-flex">
            <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
            <div>
                <h4 class="alert-heading mb-2">Profil incomplet</h4>
                <p class="mb-0">
                    Votre profil n'est pas complet. Veuillez compl√©ter vos informations pour 
                    b√©n√©ficier de toutes les fonctionnalit√©s.
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card">
                <div class="card-header bg-primary text-white text-center">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-user-plus me-2"></i>
                        {% if user_data and user_data.prenom %}
                            Modifier votre profil
                        {% else %}
                            Cr√©er votre profil
                        {% endif %}
                    </h3>
                    <p class="mb-0 mt-2 small">Personnalisez votre exp√©rience</p>
                </div>
                <div class="card-body p-4">
                    <form id="profileForm">
                        <!-- Informations personnelles -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2">
                                <i class="fas fa-user me-2 text-primary"></i>
                                Informations Personnelles
                            </h5>
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="prenom" class="form-label">Pr√©nom *</label>
                                    <input type="text" class="form-control" id="prenom" 
                                           value="{{ user_data.prenom if user_data else '' }}" 
                                           required>
                                </div>
                                <div class="col-md-6">
                                    <label for="nom" class="form-label">Nom</label>
                                    <input type="text" class="form-control" id="nom" 
                                           value="{{ user_data.nom if user_data else '' }}">
                                </div>
                            </div>
                            
                            <div class="row g-3 mt-1">
                                <div class="col-md-6">
                                    <label for="email" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="email" 
                                           value="{{ user_data.email if user_data else '' }}">
                                </div>
                                <div class="col-md-6">
                                    <label for="phone" class="form-label">T√©l√©phone *</label>
                                    <input type="tel" class="form-control" id="phone" 
                                           value="{{ user_data.phone if user_data else '' }}" 
                                           required>
                                    <div class="form-text">Pour les rappels importants</div>
                                </div>
                            </div>
                            

                        </div>

                        <!-- Situation actuelle -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2">
                                <i class="fas fa-baby me-2 text-success"></i>
                                Votre Situation
                            </h5>
                            
                            <div class="mb-3">
                                <label class="form-label">Je suis :</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="statut" 
                                           id="enceinte" value="enceinte" 
                                           {{ 'checked' if user_data and user_data.statut == 'enceinte' else 'checked' if not user_data else '' }}>
                                    <label class="form-check-label" for="enceinte">
                                        <i class="fas fa-baby-carriage me-1"></i>
                                        Femme enceinte
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="statut" 
                                           id="jeune_mere" value="jeune_mere"
                                           {{ 'checked' if user_data and user_data.statut == 'jeune_mere' else '' }}>
                                    <label class="form-check-label" for="jeune_mere">
                                        <i class="fas fa-baby me-1"></i>
                                        Jeune maman
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="statut" 
                                           id="les_deux" value="les_deux"
                                           {{ 'checked' if user_data and user_data.statut == 'les_deux' else '' }}>
                                    <label class="form-check-label" for="les_deux">
                                        <i class="fas fa-baby me-1"></i>
                                        Enceinte et d√©j√† maman
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Section enfants (conditionnelle) -->
                        <div class="mb-4 d-none" id="childrenSection">
                            <h5 class="border-bottom pb-2">
                                <i class="fas fa-child me-2 text-info"></i>
                                Informations sur vos enfants
                            </h5>
                            
                            <div id="childrenList">
                                <!-- Les champs enfants seront ajout√©s dynamiquement ici -->
                            </div>
                            
                            <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="addChildField()">
                                <i class="fas fa-plus me-1"></i>
                                Ajouter un enfant
                            </button>
                        </div>

                        <!-- Informations m√©dicales -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2">
                                <i class="fas fa-heartbeat me-2 text-danger"></i>
                                Informations M√©dicales
                            </h5>
                            
                            
                            <div class="mb-3">
                                <label class="form-label">Allergies connues</label>
                                <textarea class="form-control" id="allergies" rows="2" 
                                          placeholder="P√©nicilline, aspirine, aliments...">{{ user_data.allergies if user_data else '' }}</textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Traitements en cours</label>
                                <textarea class="form-control" id="traitements" rows="2" 
                                          placeholder="M√©dicaments, suppl√©ments...">{{ user_data.traitements if user_data else '' }}</textarea>
                            </div>
                        </div>

                        <!-- notification -->
                        <div class="mb-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="notifications"
                                       {{ 'checked' if user_data and user_data.notifications else '' }}>
                                <label class="form-check-label" for="notifications">
                                    Je souhaite recevoir des notifications et rappels par SMS.
                                </label>
                            </div>
                        </div>

                        <!-- Boutons -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save me-2"></i>
                                {% if user_data and user_data.prenom %}
                                    Mettre √† jour mon profil
                                {% else %}
                                    Enregistrer mon profil
                                {% endif %}
                            </button>
                            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                                {% if user_data and user_data.prenom %}
                                    Annuler
                                {% else %}
                                    Plus tard
                                {% endif %}
                            </a>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Avertissement m√©dical -->
            <div class="alert alert-warning mt-4">
                <h6><i class="fas fa-exclamation-triangle me-2"></i>Important</h6>
                <p class="mb-0 small">
                    Ce chatbot fournit des informations g√©n√©rales et ne remplace pas 
                    une consultation m√©dicale. En cas d'urgence, contactez le 15 ou 
                    votre professionnel de sant√©.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Variables globales
let childCount = 0;

// Initialisation au chargement
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initialisation du formulaire de profil');
    
    // V√©rifier le statut initial
    const selectedStatut = document.querySelector('input[name="statut"]:checked');
    console.log('Statut s√©lectionn√©:', selectedStatut ? selectedStatut.value : 'none');
    
    if (selectedStatut && (selectedStatut.value === 'jeune_mere' || selectedStatut.value === 'les_deux')) {
        const childrenSection = document.getElementById('childrenSection');
        childrenSection.classList.remove('d-none');
        
        // V√©rifier si on a des enfants existants
        const hasExistingChildren = {{ 'true' if user_data and user_data.children else 'false' }};
        console.log('A des enfants existants:', hasExistingChildren);
        
        if (hasExistingChildren) {
            // Note: Les donn√©es enfants doivent √™tre pass√©es depuis le backend
            // Exemple avec des donn√©es statiques (√† remplacer par vos donn√©es r√©elles)
            const existingChildren = [
                {% if user_data and user_data.children %}
                    {% for child in user_data.children %}
                    {
                        name: "{{ child.name|safe }}",
                        birth_date: "{{ child.birth_date }}",
                        gender: "{{ child.gender }}"
                    }{% if not loop.last %},{% endif %}
                    {% endfor %}
                {% endif %}
            ];
            
            console.log('Enfants √† charger:', existingChildren);
            
            // Ajouter les enfants existants
            existingChildren.forEach(child => {
                addChildField(child);
            });
        } else {
            // Ajouter un champ enfant vide par d√©faut
            addChildField();
        }
    }
    
    // Ajouter les √©couteurs d'√©v√©nements pour les radios
    document.querySelectorAll('input[name="statut"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const childrenSection = document.getElementById('childrenSection');
            if (this.value === 'jeune_mere' || this.value === 'les_deux') {
                childrenSection.classList.remove('d-none');
                // Si c'est la premi√®re fois qu'on montre la section, ajouter un champ
                if (childCount === 0) {
                    addChildField();
                }
            } else {
                childrenSection.classList.add('d-none');
            }
        });
    });
    
    // √âcouteur pour la soumission du formulaire
    document.getElementById('profileForm').addEventListener('submit', function(e) {
        e.preventDefault();
        handleFormSubmit();
    });
});

// Fonction pour ajouter un champ enfant
function addChildField(childData = {}) {
    childCount++;
    const childrenList = document.getElementById('childrenList');
    
    const childHtml = `
        <div class="child-field border p-3 mb-3 rounded">
            <div class="row g-2">
                <div class="col-md-4">
                    <label class="form-label small">Pr√©nom</label>
                    <input type="text" class="form-control form-control-sm child-name" 
                           name="child_name_${childCount}" 
                           value="${childData.name || ''}"
                           placeholder="Pr√©nom">
                </div>
                <div class="col-md-4">
                    <label class="form-label small">Date de naissance</label>
                    <input type="date" class="form-control form-control-sm child-birth-date" 
                           name="child_birth_date_${childCount}" 
                           value="${childData.birth_date || ''}">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Sexe</label>
                    <select class="form-select form-select-sm child-gender" name="child_gender_${childCount}">
                        <option value="">--</option>
                        <option value="F" ${childData.gender === 'F' ? 'selected' : ''}>Fille</option>
                        <option value="M" ${childData.gender === 'M' ? 'selected' : ''}>Gar√ßon</option>
                    </select>
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="button" class="btn btn-outline-danger btn-sm" 
                            onclick="this.parentElement.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    
    childrenList.insertAdjacentHTML('beforeend', childHtml);
    console.log(`Champ enfant ${childCount} ajout√©`);
}

// Fonction pour r√©cup√©rer les donn√©es enfants
function getChildrenData() {
    const children = [];
    const childFields = document.querySelectorAll('.child-field');
    
    childFields.forEach((field, index) => {
        const nameInput = field.querySelector('.child-name');
        const birthDateInput = field.querySelector('.child-birth-date');
        const genderSelect = field.querySelector('.child-gender');
        
        const name = nameInput ? nameInput.value : '';
        const birthDate = birthDateInput ? birthDateInput.value : '';
        const gender = genderSelect ? genderSelect.value : '';
        
        if (name && birthDate) {
            children.push({
                name: name,
                birth_date: birthDate,
                gender: gender
            });
        }
    });
    
    console.log('Donn√©es enfants r√©cup√©r√©es:', children);
    return children;
}

// Fonction pour g√©rer la soumission du formulaire
function handleFormSubmit() {
    const submitButton = document.querySelector('#profileForm button[type="submit"]');
    const originalText = submitButton.innerHTML;
    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Enregistrement...';
    submitButton.disabled = true;
    
    // R√©cup√©ration des donn√©es du formulaire
    const formData = {
        nom: document.getElementById('nom').value,
        prenom: document.getElementById('prenom').value,
        email: document.getElementById('email').value,
        phone: document.getElementById('phone').value,
        statut: document.querySelector('input[name="statut"]:checked').value,
        allergies: document.getElementById('allergies').value,
        traitements: document.getElementById('traitements').value,
        notifications: document.getElementById('notifications').checked,
        children: getChildrenData()
    };
    
    console.log('üì§ Donn√©es √† envoyer:', formData);
    
    // D√©terminer la m√©thode HTTP et l'URL
    const isUpdate = {{ 'true' if user_data and user_data.prenom else 'false' }};
    const method = isUpdate ? 'PUT' : 'POST';
    const endpoint = '/api/profile';
    
    console.log(`M√©thode: ${method}, Endpoint: ${endpoint}`);
    
    // Envoyer les donn√©es au serveur
    fetch(endpoint, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => {
        console.log('Status de la r√©ponse:', response.status);
        return response.json().then(data => ({ 
            status: response.status, 
            data 
        }));
    })
    .then(({ status, data }) => {
        console.log('üì• R√©ponse API:', data);
        
        if (status === 200 || status === 201) {
            // Succ√®s
            showNotification('success', data.message || 'Profil enregistr√© avec succ√®s !');
            setTimeout(() => {
                window.location.href = '/dashboard';
            }, 1500);
        } else if (status === 400) {
            // Erreur de validation
            showNotification('error', data.error || 'Donn√©es invalides');
            
            // Surligner les champs en erreur
            if (data.error && data.error.includes('email')) {
                document.getElementById('email').classList.add('is-invalid');
            }
            if (data.error && data.error.includes('t√©l√©phone')) {
                document.getElementById('phone').classList.add('is-invalid');
            }
        } else {
            // Autre erreur
            throw new Error(data.error || `Erreur ${status}`);
        }
    })
    .catch(error => {
        console.error('‚ùå Erreur:', error);
        showNotification('error', 'Erreur: ' + error.message);
    })
    .finally(() => {
        submitButton.innerHTML = originalText;
        submitButton.disabled = false;
    });
}

// Fonction pour afficher les notifications
function showNotification(type, message) {
    // Supprimer les notifications existantes
    const existingNotifications = document.querySelectorAll('.alert-dismissible');
    existingNotifications.forEach(notification => {
        notification.remove();
    });
    
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check' : 'exclamation-triangle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const mainElement = document.querySelector('main');
    if (mainElement) {
        mainElement.prepend(notification);
        
        // Auto-dismiss apr√®s 5 secondes
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 5000);
    }
}

// Supprimer les classes d'erreur quand l'utilisateur tape
document.getElementById('email')?.addEventListener('input', function() {
    this.classList.remove('is-invalid');
});

document.getElementById('phone')?.addEventListener('input', function() {
    this.classList.remove('is-invalid');
});
</script>
{% endblock %}